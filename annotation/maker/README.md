# Step 4. Genome annotation using [MAKER](http://www.yandell-lab.org/software/maker.html).

__Software prerequisites__

1. [RepeatModeler](http://www.repeatmasker.org/RepeatModeler/) and [RepeatMasker](http://www.repeatmasker.org/) with all dependencies and [Repbase](https://www.girinst.org/repbase/).  
2. `MAKER`.  
3. [AUGUSTUS](http://bioinf.uni-greifswald.de/augustus/).  
4. [BUSCO](https://busco.ezlab.org/).  
5. [SNAP](https://github.com/KorfLab/SNAP).  
6. [BEDtools](https://bedtools.readthedocs.io/en/latest/).  

__Step 4.1__. Initial `MAKER` analysis.

The input files for `MAKER` are a number of control files, which are generated by issuing the command `maker -CTL`. The only control file we will be altering is the `maker_opts.ctl` file. In this first round of `MAKER`, we will obviously be providing the data files for the repeat annotation (`rm_gff`), the transcriptome assembly(ies) (`est`), and other protein sequences for homology-based evidence (`protein`). We will also set the `model_org` to 'simple' so that only simple repeats are annotated (along with `RepeatRunner`). Below is the control file with unused commands removed.

```bash
cat maker_opts.ctl

#-----Genome (these are always required)
genome=<genome assembly fasta file> #genome sequence (fasta file or fasta embeded in GFF3 file)
organism_type=eukaryotic #eukaryotic or prokaryotic. Default is eukaryotic

#-----Re-annotation Using MAKER Derived GFF3
est_pass=0 #use ESTs in maker_gff: 1 = yes, 0 = no
altest_pass=0 #use alternate organism ESTs in maker_gff: 1 = yes, 0 = no
protein_pass=0 #use protein alignments in maker_gff: 1 = yes, 0 = no
rm_pass=0 #use repeats in maker_gff: 1 = yes, 0 = no
model_pass=0 #use gene models in maker_gff: 1 = yes, 0 = no
pred_pass=0 #use ab-initio predictions in maker_gff: 1 = yes, 0 = no
other_pass=0 #passthrough anyything else in maker_gff: 1 = yes, 0 = no

#-----EST Evidence (for best results provide a file for at least one)
est=<PASA comprehensive database fasta files> #set of ESTs or assembled mRNA-seq in fasta format

#-----Protein Homology Evidence (for best results provide a file for at least one)
protein=<fasta files>  #protein sequence file in fasta format (i.e. from mutiple organisms)

#-----Repeat Masking (leave values blank to skip repeat masking)
model_org=simple #select a model organism for RepBase masking in RepeatMasker
repeat_protein=<MAKER's te_proteins.fasta, i.e., .../maker/.../data/te_proteins.fasta> #provide a fasta file of transposable element proteins for RepeatRunner
rm_gff=<${INDEX}.full_mask.complex.reformat.gff3> #pre-identified repeat elements from an external GFF3 file
prok_rm=0 #forces MAKER to repeatmask prokaryotes (no reason to change this), 1 = yes, 0 = no
softmask=1 #use soft-masking rather than hard-masking in BLAST (i.e. seg and dust filtering)

#-----Gene Prediction
est2genome=1 #infer gene predictions directly from ESTs, 1 = yes, 0 = no
protein2genome=1 #infer predictions from protein homology, 1 = yes, 0 = no
trna=0 #find tRNAs with tRNAscan, 1 = yes, 0 = no
unmask=0 #also run ab-initio prediction programs on unmasked sequence, 1 = yes, 0 = no

#-----External Application Behavior Options
alt_peptide=C #amino acid used to replace non-standard amino acids in BLAST databases
cpus=1 #max number of cpus to use in BLAST and RepeatMasker (not for MPI, leave 1 when using MPI)

#-----MAKER Behavior Options
max_dna_len=100000 #length for dividing up contigs into chunks (increases/decreases memory usage)
min_contig=1 #skip genome contigs below this length (under 10kb are often useless)

pred_flank=200 #flank for extending evidence clusters sent to gene predictors
pred_stats=0 #report AED and QI statistics for all predictions as well as models
AED_threshold=1 #Maximum Annotation Edit Distance allowed (bound by 0 and 1)
min_protein=0 #require at least this many amino acids in predicted proteins
alt_splice=0 #Take extra steps to try and find alternative splicing, 1 = yes, 0 = no
always_complete=0 #extra steps to force start and stop codons, 1 = yes, 0 = no
map_forward=0 #map names and attributes forward from old GFF3 genes, 1 = yes, 0 = no
keep_preds=0 #Concordance threshold to add unsupported gene prediction (bound by 0 and 1)

split_hit=10000 #length for the splitting of hits (expected max intron size for evidence alignments)
single_exon=0 #consider single exon EST evidence when generating annotations, 1 = yes, 0 = no
single_length=250 #min length required for single exon ESTs if 'single_exon is enabled'
correct_est_fusion=0 #limits use of ESTs in annotation to avoid fusion genes

tries=2 #number of times to try a contig if there is a failure for some reason
clean_try=0 #remove all data from previous run before retrying, 1 = yes, 0 = no
clean_up=0 #removes theVoid directory with individual analysis files, 1 = yes, 0 = no
```

Run `MAKER` using a bash script.

```bash
cat maker-round1.sh

JOBID="" #job id
CPU="" #number of CPUs
ABBR="" #species abbreviation, typically first three letters of genus and species

mkdir -p /tmp/lscratch/${JOBID}/tmp
maker -cpus ${CPU} -base ${ABBR} -TMP /tmp/lscratch/${JOBID}/tmp maker_opts.ctl maker_bopts.ctl maker_exe.ctl
```

`MAKER` will be using [BLAST](https://blast.ncbi.nlm.nih.gov/Blast.cgi?CMD=Web&PAGE_TYPE=BlastDocs&DOC_TYPE=Download) to align transcripts and proteins to the genome, so this will take a very long time. Speed is a product of the resources you allow (more cores == shorter runtime) and the assembly quality (small, less contiguous scaffolds == longer runtime or long, more contiguous scaffolds == longer runtime). Additionally, the first rounf of `MAKER` takes the longest. To speed-up `MAKER` use more cores or break the genome assembly fasta file into chunks, essentially parallelizing `MAKER`.

After `MAKER` is done running we assemble together the GFF and FASTA outputs.

```bash
cd ${ABBR}.maker.output
gff3_merge -s -d ${ABBR}_master_datastore_index.log > ${ABBR}.all.maker.gff
fasta_merge -d ${ABBR}_master_datastore_index.log
# GFF w/o the sequences
gff3_merge -n -s -d ${ABBR}_master_datastore_index.log > ${ABBR}.all.maker.noseq.gff
```

__Step 4.2__. Training gene prediction software.

__SNAP__

__AUGUSTUS__
